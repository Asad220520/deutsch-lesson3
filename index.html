<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lektion 3 ‚Äî DE‚ÄìRU Phrase Trainer</title>
    <meta name="description" content="–õ–æ–≥–∏–∫–∞ —É—Ä–æ–∫–∞ –∏ –º–Ω–æ–≥–æ –ø—Ä–∞–∫—Ç–∏–∫–∏: —Å–ª—É—à–∞–π ‚Üí –≥–æ–≤–æ—Ä–∏ ‚Üí –ø–∏—à–∏. RU‚ÜíDE –≤–≤–æ–¥, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –≥–æ–ª–æ—Å, –æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –õ–µ–π—Ç–Ω–µ—Ä-–ø–æ–≤—Ç–æ—Ä –∏ –¥–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å. –í—Å—ë –æ—Ñ–ª–∞–π–Ω –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ." />
    <style>
      :root {
        --bg: #000;
        --panel: #0a0a0a;
        --text: #f5f5f5;
        --muted: #a9a9a9;
        --border: #1f1f1f;
        --ok: #2ecc71;
        --bad: #ff7675;
        --hint: #ffd166;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }
      .wrap { max-width: 820px; margin-inline: auto; padding: 16px; padding-bottom: 128px; }

      header { display: grid; gap: 8px; }
      .title { font-size: clamp(20px, 5vw, 28px); font-weight: 800; display:flex; gap:10px; align-items:center; }
      .subtitle { color: var(--muted); font-size: 14px; }

      .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
      .grid { display:grid; grid-template-columns:1fr; gap:12px; }

      input, select, button, .pill {
        appearance: none; background: #0b0b0b; border: 1px solid var(--border);
        color: var(--text); border-radius: 12px; padding: 12px 14px; font: inherit; min-height: 48px;
      }
      button { cursor: pointer; }
      button:active { transform: translateY(1px); }
      .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .flex { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .tiny { font-size:12px; color:var(--muted); }
      .hidden { display:none !important; }
      .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

      /* bottom tabs */
      .tabs {
        position: fixed; left: 0; right: 0; bottom: 0; z-index: 60;
        background: rgba(0,0,0,0.9); backdrop-filter: blur(6px);
        border-top: 1px solid var(--border);
        padding: 8px max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        display: grid; grid-template-columns: repeat(8,1fr); gap: 8px; margin: 0;
      }
      .tab {
        height: 56px; display: grid; place-items: center;
        border: 1px solid var(--border); border-radius: 12px; background:#0a0a0a;
      }
      .tab.active { outline: 2px solid #fff; outline-offset: 2px; }

      /* list card */
      .card {
        background: var(--panel); border: 1px solid var(--border); border-radius: 14px;
        padding: 14px; display: grid; grid-template-columns: 44px 1fr auto; gap: 10px; align-items: center;
      }
      .de { font-weight: 800; font-size: 18px; }
      .ru { color: var(--muted); margin-top: 2px; font-size: 15px; }
      .actions { display:flex; gap:6px; flex-wrap:wrap; }

      /* learn / flash */
      .flash-card {
        background: var(--panel); border:1px solid var(--border); border-radius:18px;
        padding:20px; text-align:center; min-height:160px; display:grid; place-items:center; gap:6px; position:relative;
      }
      .learn-big { font-size:22px; font-weight:800; text-align:center; }
      .learn-sub { color:var(--muted); text-align:center; }

      /* practice / feedback */
      .feedback { padding:10px; border-radius:10px; border:1px solid var(--border); }
      .good { background: rgba(46, 204, 113, 0.12); }
      .badmsg { background: rgba(255, 118, 117, 0.12); }
      mark.ok { background: rgba(46, 204, 113, 0.35); padding:2px 3px; border-radius:4px; }
      mark.diff { background: rgba(255, 118, 117, 0.35); padding:2px 3px; border-radius:4px; }
      .hint { background: rgba(255, 209, 102, 0.16); border:1px dashed #775; padding:8px; border-radius:8px; }

      /* builder */
      .assembly { min-height: 52px; display:flex; flex-wrap:wrap; gap:8px; padding:10px; border:1px dashed var(--border); border-radius:10px; background:#0b0b0b; }
      .tokens { display:flex; flex-wrap:wrap; gap:8px; }
      .token { padding:8px 10px; background:#0b0b0b; border:1px solid var(--border); border-radius:10px; cursor:pointer; user-select:none; }
      .token.used { opacity:0.35; pointer-events:none; }

      /* quiz */
      .quiz { display:grid; gap:10px; }
      .quiz-q { background: var(--panel); border:1px solid var(--border); padding:14px; border-radius:14px; }
      .answers { display:grid; gap:8px; }
      .answer { padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0b0b0b; }
      .answer.correct { outline:2px solid #eaeaea; }
      .answer.wrong { outline:2px dashed #666; }

      /* dialogs */
      dialog.modal {
        border: 1px solid var(--border); border-radius: 16px; background:#0b0b0b; color:var(--text);
        padding: 16px; max-width: 720px; width: 92vw;
      }
      dialog.modal::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
      .modal-section { border-top:1px solid var(--border); padding-top:10px; margin-top:10px; }
      .modal-title { font-weight:800; font-size:18px; display:flex; gap:8px; align-items:center; }

      /* daily goal */
      .goal { display:grid; gap:6px; }
      .bar { height: 8px; background:#0b0b0b; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
      .bar-fill { height:100%; width:0%; background: linear-gradient(90deg, #8ec5ff, #e3ffe7); transition: width .25s ease; }

      /* icons */
      .lci { width: 28px; height: 28px; stroke: currentColor; }
      .big-lci { width: 44px; height: 44px; stroke: currentColor; }
    </style>
    <script src="https://unpkg.com/lucide@0.462.0/dist/umd/lucide.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="title"><i data-lucide="book-open" class="lci"></i> Lektion 3 ‚Äî DE‚ÄìRU Phrase Trainer</div>
        <div class="subtitle">–£—á—ë–±–∞ ‚Üí –ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Üí –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä ‚Üí –¢–µ—Å—Ç ‚Üí –ü–æ–≤—Ç–æ—Ä. –û–±—ä—è—Å–Ω–µ–Ω–∏—è –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.</div>
        <div class="goal panel">
          <div class="row" style="justify-content:space-between;">
            <div class="tiny">üéØ –¶–µ–ª—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: <strong><span id="goalDone">0</span>/<span id="goalTotal">20</span></strong></div>
            <button id="openSettings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><i data-lucide="settings-2" class="lci"></i></button>
          </div>
          <div class="bar"><div id="goalFill" class="bar-fill"></div></div>
        </div>
      </header>

      <!-- –ü–æ–∏—Å–∫ -->
      <section class="panel" aria-label="–ü–æ–∏—Å–∫">
        <div class="row">
          <label class="pill" style="display:flex;align-items:center;gap:8px;">
            <i data-lucide="search" class="lci" aria-hidden="true"></i>
            <input id="search" type="text" placeholder="–ù–∞–π—Ç–∏: —Å–ª–æ–≤–æ –Ω–∞ –Ω–µ–º./—Ä—É—Å." aria-label="–ü–æ–∏—Å–∫" />
          </label>
          <button id="shuffle" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å"><i data-lucide="shuffle" class="lci"></i></button>
        </div>
      </section>

      <!-- –°–ø–∏—Å–æ–∫ -->
      <section id="tab-list" class="tab-panel" role="tabpanel">
        <div id="list" class="grid" aria-live="polite"></div>
      </section>

      <!-- –£—á—ë–±–∞ (—Å–ª—É—à–∞–π/—Å–º–æ—Ç—Ä–∏/–æ–±—ä—è—Å–Ω–∏) -->
      <section id="tab-learn" class="tab-panel hidden" role="tabpanel">
        <div class="flash-card">
          <div class="learn-big" id="learnFront">‚Ä¶</div>
          <div class="learn-sub" id="learnBack">–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥¬ª</div>
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="learnPrev" title="–ù–∞–∑–∞–¥"><i data-lucide="chevron-left" class="lci"></i></button>
          <button id="learnSpeakDE" title="–û–∑–≤—É—á–∏—Ç—å (DE)"><i data-lucide="volume" class="lci"></i></button>
          <button id="learnSpeakRU" title="–û–∑–≤—É—á–∏—Ç—å (RU)"><i data-lucide="volume-2" class="lci"></i></button>
          <button id="learnReveal" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥"><i data-lucide="eye" class="lci"></i></button>
          <button id="learnExplain" title="–û–±—ä—è—Å–Ω–∏—Ç—å"><i data-lucide="book-marked" class="lci"></i></button>
          <button id="learnNext" title="–í–ø–µ—Ä—ë–¥"><i data-lucide="chevron-right" class="lci"></i></button>
        </div>
        <div class="tiny" style="margin-top:6px;">–®–∞–≥: 1) –ø–æ—Å–ª—É—à–∞–π—Ç–µ DE, 2) –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ, 3) —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º, 4) –æ—Ç–∫—Ä–æ–π—Ç–µ ¬´–û–±—ä—è—Å–Ω–∏—Ç—å¬ª, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ.</div>
      </section>

      <!-- –ü—Ä–∞–∫—Ç–∏–∫–∞ (RU‚ÜíDE –≤–≤–æ–¥ + –≥–æ–ª–æ—Å) -->
      <section id="tab-practice" class="tab-panel hidden" role="tabpanel">
        <div class="panel">
          <div class="tiny">–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ-–Ω–µ–º–µ—Ü–∫–∏. –ú–æ–∂–Ω–æ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥.</div>
          <div id="prTask" class="learn-big" style="margin-top:6px;">‚Ä¶</div>
          <input id="prInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–µ–º–µ—Ü–∫–∏–π..." />
          <div class="row" style="margin-top:6px;">
            <button id="prHint"><i data-lucide="lightbulb" class="lci"></i> –ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
            <button id="prMic" class="hidden"><i data-lucide="mic" class="lci"></i> –°–∫–∞–∑–∞—Ç—å</button>
            <button id="prCheck" class="btn-accent"><i data-lucide="check" class="lci"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button id="prExplain"><i data-lucide="book-marked" class="lci"></i> –û–±—ä—è—Å–Ω–∏—Ç—å</button>
            <button id="prNext"><i data-lucide="chevron-right" class="lci"></i> –î–∞–ª–µ–µ</button>
          </div>
          <div id="prVoice" class="tiny hidden" style="margin-top:4px;"></div>
          <div id="prFeedback" class="feedback hidden" style="margin-top:8px;"></div>
          <div id="prHintBox" class="hint hidden" style="margin-top:6px;"></div>
          <div class="tiny" style="margin-top:6px;">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="prProgress">0 / 0</span>. –û—à–∏–±–∫–∏: <span id="prMistakes">0</span></div>
        </div>
      </section>

      <!-- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (—Å–æ–±–µ—Ä–∏ –∏–∑ —Å–ª–æ–≤) -->
      <section id="tab-build" class="tab-panel hidden" role="tabpanel">
        <div class="panel">
          <div class="tiny">–°–æ–±–µ—Ä–∏—Ç–µ –Ω–µ–º–µ—Ü–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Å–ª–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.</div>
          <div id="bdTask" class="learn-big" style="margin-top:6px;">‚Ä¶</div>
          <div id="bdAssembly" class="assembly" aria-label="–°–æ–±—Ä–∞–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞"></div>
          <div id="bdTokens" class="tokens" aria-label="–°–ª–æ–≤–∞ –¥–ª—è —Ñ—Ä–∞–∑—ã" style="margin-top:8px;"></div>
          <div class="row" style="margin-top:8px;">
            <button id="bdHint"><i data-lucide="lightbulb" class="lci"></i> –ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
            <button id="bdClear"><i data-lucide="eraser" class="lci"></i> –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button id="bdCheck" class="btn-accent"><i data-lucide="check" class="lci"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button id="bdExplain"><i data-lucide="book-marked" class="lci"></i> –û–±—ä—è—Å–Ω–∏—Ç—å</button>
            <button id="bdNext"><i data-lucide="chevron-right" class="lci"></i> –î–∞–ª–µ–µ</button>
          </div>
          <div id="bdFeedback" class="feedback hidden" style="margin-top:8px;"></div>
        </div>
      </section>

      <!-- –¢–µ—Å—Ç -->
      <section id="tab-quiz" class="tab-panel hidden" role="tabpanel">
        <div class="quiz">
          <div class="row">
            <button id="quizStart" class="btn-accent" title="–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç"><i data-lucide="play" class="lci"></i> –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç (10 –≤–æ–ø—Ä–æ—Å–æ–≤)</button>
            <div class="pill" style="display:flex;align-items:center;gap:8px;">
              <i data-lucide="line-chart" class="lci"></i>
              <span>–†–µ–∑—É–ª—å—Ç–∞—Ç: <span id="quizScore" class="score">0 / 0</span></span>
            </div>
          </div>
          <div id="quizArea"></div>
        </div>
      </section>

      <!-- –ü–æ–≤—Ç–æ—Ä (–õ–µ–π—Ç–Ω–µ—Ä) -->
      <section id="tab-review" class="tab-panel hidden" role="tabpanel">
        <div class="panel">
          <div class="row" style="justify-content:space-between;">
            <div>–ü–æ–≤—Ç–æ—Ä –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º –õ–µ–π—Ç–Ω–µ—Ä–∞</div>
            <div class="tiny">–î–æ–ª–∂–Ω–æ —Å–µ–≥–æ–¥–Ω—è: <strong id="rvDue">0</strong></div>
          </div>
          <div id="rvTask" class="learn-big" style="margin-top:6px;">–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª</div>
          <input id="rvInput" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ-–Ω–µ–º–µ—Ü–∫–∏‚Ä¶" />
          <div class="row" style="margin-top:6px;">
            <button id="rvStart"><i data-lucide="refresh-ccw" class="lci"></i> –ù–∞—á–∞—Ç—å</button>
            <button id="rvCheck" class="btn-accent"><i data-lucide="check" class="lci"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button id="rvHard"><i data-lucide="alert-triangle" class="lci"></i> –°–ª–æ–∂–Ω–æ</button>
            <button id="rvNext"><i data-lucide="chevron-right" class="lci"></i> –î–∞–ª–µ–µ</button>
          </div>
          <div id="rvFeedback" class="feedback hidden" style="margin-top:8px;"></div>
          <div class="tiny" style="margin-top:6px;">–ö–æ—Ä–æ–±–∫–∏: <span id="rvStats">‚Äî</span></div>
        </div>
      </section>

      <!-- –ì–ª–∞–≥–æ–ª—ã -->
      <section id="tab-verbs" class="tab-panel hidden" role="tabpanel">
        <div id="verbs"></div>
        <div class="panel" style="margin-top:12px;">
          <strong>–í—Å—Ç–∞–≤—å—Ç–µ —Ñ–æ—Ä–º—É ‚Äûm√∂chten‚Äú:</strong>
          <div class="row" style="flex-direction:column;align-items:flex-start;">
            <div>1. <b>Ich</b> <input data-a="moechte|m√∂chte" /> ein Eis.</div>
            <div>2. <b>Du</b> <input data-a="moechtest|m√∂chtest" /> einen Kaffee?</div>
            <div>3. <b>Er</b> <input data-a="moechte|m√∂chte" /> ein Buch lesen.</div>
            <div>4. <b>Wir</b> <input data-a="moechten|m√∂chten" /> ein Zimmer mit Meerblick.</div>
            <div>5. <b>Ihr</b> <input data-a="moechtet|m√∂chtet" /> eine Cola?</div>
            <div>6. <b>Sie</b> <input data-a="moechten|m√∂chten" /> ein Ticket nach Berlin.</div>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="moeCheck"><i data-lucide="check" class="lci"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button id="moeShow"><i data-lucide="eye" class="lci"></i> –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          </div>
        </div>
      </section>

      <!-- –ß–∏—Å–ª–∞ -->
      <section id="tab-numbers" class="tab-panel hidden" role="tabpanel">
        <div class="panel">
          <div class="row">
            <label class="pill" style="display:flex;align-items:center;gap:8px;">
              <i data-lucide="search" class="lci"></i>
              <input id="numSearch" type="text" placeholder="–ü–æ–∏—Å–∫: 21 / einundzwanzig" aria-label="–ü–æ–∏—Å–∫ —á–∏—Å–ª–∞" />
            </label>
            <button id="numShuffle" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å"><i data-lucide="shuffle" class="lci"></i></button>
          </div>
        </div>
        <div id="numbers" class="grid" aria-live="polite" style="grid-template-columns:repeat(2,1fr);"></div>
      </section>
    </div>

    <!-- bottom nav -->
    <nav class="tabs" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <button class="tab active" data-tab="list" title="–°–ø–∏—Å–æ–∫"><i data-lucide="list" class="lci"></i></button>
      <button class="tab" data-tab="learn" title="–£—á—ë–±–∞"><i data-lucide="graduation-cap" class="lci"></i></button>
      <button class="tab" data-tab="practice" title="–ü—Ä–∞–∫—Ç–∏–∫–∞"><i data-lucide="keyboard" class="lci"></i></button>
      <button class="tab" data-tab="build" title="–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä"><i data-lucide="puzzle" class="lci"></i></button>
      <button class="tab" data-tab="quiz" title="–¢–µ—Å—Ç"><i data-lucide="edit-3" class="lci"></i></button>
      <button class="tab" data-tab="review" title="–ü–æ–≤—Ç–æ—Ä"><i data-lucide="repeat" class="lci"></i></button>
      <button class="tab" data-tab="verbs" title="–ì–ª–∞–≥–æ–ª—ã"><i data-lucide="type" class="lci"></i></button>
      <button class="tab" data-tab="numbers" title="–ß–∏—Å–ª–∞"><i data-lucide="hash" class="lci"></i></button>
    </nav>

    <!-- SETTINGS -->
    <dialog id="settingsDialog" class="modal" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
      <div class="modal-title"><i data-lucide="settings-2" class="lci"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="modal-section">
        <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å
          <select id="difficulty">
            <option value="all">–í—Å–µ</option>
            <option value="short">–ö–æ—Ä–æ—Ç–∫–∏–µ</option>
            <option value="long">–î–ª–∏–Ω–Ω—ã–µ</option>
          </select>
        </label>
      </div>
      <div class="modal-section">
        <label>–ì–æ–ª–æ—Å (DE)
          <select id="voiceDE"></select>
        </label>
      </div>
      <div class="modal-section">
        <label>–ì–æ–ª–æ—Å (RU)
          <select id="voiceRU"></select>
        </label>
      </div>
      <div class="modal-section">
        <label>–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏
          <input id="rate" type="number" min="0.6" max="1.4" step="0.1" value="1.0" />
        </label>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button id="closeSettings"><i data-lucide="check" class="lci"></i> –ì–æ—Ç–æ–≤–æ</button>
      </div>
    </dialog>

    <!-- EXPLAIN -->
    <dialog id="explainDialog" class="modal" aria-label="–û–±—ä—è—Å–Ω–µ–Ω–∏–µ">
      <div class="modal-title"><i data-lucide="book-marked" class="lci"></i> –û–±—ä—è—Å–Ω–µ–Ω–∏–µ</div>
      <div id="explainBody" class="modal-section">‚Ä¶</div>
      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button id="closeExplain"><i data-lucide="x" class="lci"></i> –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </dialog>

    <script>
      /* ============== DATA & EXPLANATIONS ============== */
      const DATA = [
        { id:1,  de:"Wir m√∂chten heute tanzen.",             ru:"–ú—ã —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ç–∏–º —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å." },
        { id:2,  de:"Ich mag Pizza essen.",                  ru:"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –ø–∏—Ü—Ü–∞." },
        { id:3,  de:"Ich m√∂chte in Deutschland arbeiten.",   ru:"–Ø —Ö–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ì–µ—Ä–º–∞–Ω–∏–∏." },
        { id:4,  de:"Du bist sehr sch√∂n.",                   ru:"–¢—ã –æ—á–µ–Ω—å –∫—Ä–∞—Å–∏–≤–∞—è(—ã–π)." },
        { id:5,  de:"Mein Bruder ist klein.",                ru:"–ú–æ–π –±—Ä–∞—Ç –º–∞–ª–µ–Ω—å–∫–∏–π." },
        { id:6,  de:"Meine Eltern sind in Naryn.",           ru:"–ú–æ–∏ —Ä–æ–¥–∏—Ç–µ–ª–∏ –≤ –ù–∞—Ä—ã–Ω–µ." },
        { id:7,  de:"Ich habe eine gro√üe Familie.",          ru:"–£ –º–µ–Ω—è –±–æ–ª—å—à–∞—è —Å–µ–º—å—è." },
        { id:8,  de:"Er hat zwei Kinder.",                   ru:"–£ –Ω–µ–≥–æ –¥–≤–∞ —Ä–µ–±—ë–Ω–∫–∞." },
        { id:9,  de:"Wir haben viele Hausaufgaben.",         ru:"–£ –Ω–∞—Å –º–Ω–æ–≥–æ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π." },
        { id:10, de:"Mein Name ist Aizhan.",                 ru:"–ú–æ—ë –∏–º—è –ê–π–∂–∞–Ω." },
        { id:11, de:"Kommst du aus Osch?",                   ru:"–¢—ã –∏–∑ –û—à–∞?" },
        { id:12, de:"Ich wei√ü nicht.",                       ru:"–Ø –Ω–µ –∑–Ω–∞—é." },
        { id:13, de:'Wir wissen das Wort ‚ÄûGlas‚Äú nicht.',     ru:'–ú—ã –Ω–µ –∑–Ω–∞–µ–º —Å–ª–æ–≤–æ ¬´—Å—Ç–∞–∫–∞–Ω¬ª.' },
        { id:14, de:"Mein Kopf tut mir weh.",                ru:"–£ –º–µ–Ω—è –±–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞." },
        { id:15, de:"Lernst du gern Deutsch?",               ru:"–¢–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —É—á–∏—Ç—å –Ω–µ–º–µ—Ü–∫–∏–π?" },
        { id:16, de:"Hast du heute Freizeit?",               ru:"–£ —Ç–µ–±—è –µ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è?" },
        { id:17, de:"Sind Sie krank?",                       ru:"–í—ã –±–æ–ª–µ–µ—Ç–µ? / –í—ã –±–æ–ª—å–Ω—ã?" },
        { id:18, de:"Ich bin ein bisschen m√ºde.",            ru:"–Ø –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞–≤—à–∏–π." },
        { id:19, de:"Habt ihr noch Fragen?",                 ru:"–£ –≤–∞—Å –µ—Å—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã?" },
        { id:20, de:"Ich habe keine Zeit.",                  ru:"–£ –º–µ–Ω—è –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏." },
      ];

      const EXPLAIN = {
        1:{ gram:"m√∂chten + Infinitiv (–≤–µ–∂–ª–∏–≤–æ–µ ¬´—Ö–æ—Ç–µ—Ç—å¬ª); heute ‚Äî –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–∏.", alt:"Heute m√∂chten wir tanzen.", vocab:"m√∂chten ‚Äî —Ö–æ—Ç–µ—Ç—å; tanzen ‚Äî —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å." },
        2:{ gram:"m√∂gen + Akk.; —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–µ–µ: ‚Äûgern‚Äú.", alt:"Ich esse gern Pizza.", vocab:"m√∂gen ‚Äî –Ω—Ä–∞–≤–∏—Ç—å—Å—è; essen ‚Äî –µ—Å—Ç—å." },
        3:{ gram:"in + Dativ: in Deutschland.", alt:"Ich will in Deutschland arbeiten.", vocab:"arbeiten ‚Äî —Ä–∞–±–æ—Ç–∞—Ç—å." },
        4:{ gram:"sein + Adj.: Du bist sch√∂n.", alt:"Du siehst sehr sch√∂n aus.", vocab:"sch√∂n ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π." },
        5:{ gram:"–ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ—Å–ª–µ sein.", alt:"Mein Bruder ist noch klein.", vocab:"Bruder ‚Äî –±—Ä–∞—Ç; klein ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π." },
        6:{ gram:"sein + –º–µ—Å—Ç–æ: in Naryn.", alt:"Meine Eltern sind jetzt in Naryn.", vocab:"Eltern ‚Äî —Ä–æ–¥–∏—Ç–µ–ª–∏." },
        7:{ gram:"–° –Ω–µ–æ–ø—Ä–µ–¥. –∑–Ω–∞—á–µ–Ω–∏–µ–º –Ω—É–∂–µ–Ω –∞—Ä—Ç–∏–∫–ª—å: eine gro√üe Familie.", alt:"‚Äî", vocab:"Familie ‚Äî —Å–µ–º—å—è; gro√ü ‚Äî –±–æ–ª—å—à–æ–π." },
        8:{ gram:"–ß–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ: zwei Kinder (–±–µ–∑ –∞—Ä—Ç–∏–∫–ª—è).", alt:"‚Äî", vocab:"Kinder ‚Äî –¥–µ—Ç–∏." },
        9:{ gram:"‚Äûviele‚Äú + Pl.: Hausaufgaben ‚Äî Pl.", alt:"‚Äî", vocab:"Hausaufgaben ‚Äî –¥–∑." },
        10:{ gram:"–§–æ—Ä–º—É–ª–∞ –∏–º–µ–Ω–∏: ‚ÄûIch hei√üe ‚Ä¶‚Äú —Ç–æ–∂–µ –æ–∫.", alt:"Ich hei√üe Aizhan.", vocab:"hei√üen ‚Äî –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è." },
        11:{ gram:"–í–æ–ø—Ä–æ—Å –æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏: ‚ÄûKommst du aus ‚Ä¶?‚Äú", alt:"Bist du aus Osch?", vocab:"kommen aus ‚Äî –±—ã—Ç—å —Ä–æ–¥–æ–º –∏–∑." },
        12:{ gram:"wei√ü ‚Äî —Ñ–æ—Ä–º–∞ wissen.", alt:"Keine Ahnung.", vocab:"wissen ‚Äî –∑–Ω–∞—Ç—å." },
        13:{ gram:"Nicht –≤ –∫–æ–Ω—Ü–µ: ‚Ä¶ Wort ‚ÄûGlas‚Äú nicht.", alt:"Wir kennen das Wort ‚ÄûGlas‚Äú nicht.", vocab:"das Wort ‚Äî —Å–ª–æ–≤–æ; das Glas ‚Äî —Å—Ç–∞–∫–∞–Ω." },
        14:{ gram:"tun + Dativ mir weh.", alt:"Ich habe Kopfschmerzen.", vocab:"der Kopf ‚Äî –≥–æ–ª–æ–≤–∞." },
        15:{ gram:"gern ‚Äî ¬´—Å –æ—Ö–æ—Ç–æ–π¬ª; –≤–æ–ø—Ä–æ—Å: Lernst du gern ‚Ä¶?", alt:"Magst du Deutsch lernen?", vocab:"lernen ‚Äî —É—á–∏—Ç—å." },
        16:{ gram:"Hast du ‚Ä¶ Freizeit? –ù–∞—Ç—É—Ä–∞–ª—å–Ω–µ–µ: Zeit.", alt:"Hast du heute Zeit?", vocab:"Zeit ‚Äî –≤—Ä–µ–º—è; Freizeit ‚Äî –¥–æ—Å—É–≥." },
        17:{ gram:"Sie ‚Äî –≤–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞.", alt:"Geht es Ihnen nicht gut?", vocab:"krank ‚Äî –±–æ–ª—å–Ω–æ–π." },
        18:{ gram:"ein bisschen = –Ω–µ–º–Ω–æ–≥–æ.", alt:"Ich bin etwas/ein wenig m√ºde.", vocab:"m√ºde ‚Äî —É—Å—Ç–∞–≤—à–∏–π." },
        19:{ gram:"ihr ‚Äî ¬´–≤—ã¬ª (–º–Ω.).", alt:"Habt ihr Fragen?", vocab:"Fragen ‚Äî –≤–æ–ø—Ä–æ—Å—ã." },
        20:{ gram:"keine Zeit ‚Äî –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ —Å—É—â.", alt:"Ich bin besch√§ftigt.", vocab:"Zeit ‚Äî –≤—Ä–µ–º—è." },
      };

      /* ============== ICONS MAP ============== */
      const ICONS = {
        1:"music",2:"pizza",3:"briefcase",4:"sparkles",5:"user",6:"map-pin",7:"users",8:"baby",
        9:"book-open",10:"badge",11:"map-pin",12:"help-circle",13:"cup-soda",14:"pill",15:"book-open",
        16:"clock",17:"thermometer",18:"moon",19:"help-circle",20:"timer-off",
      };

      /* ============== UTILITIES ============== */
      const $ = (sel)=>document.querySelector(sel);
      const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
      function applyLucide(){ if(window.lucide){ try{ window.lucide.createIcons({attrs:{class:"lci","stroke-width":1.8}});}catch{} } }
      function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }
      function escapeHTML(s){ return (s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
      function normDE(s){
        return (s||"").toLowerCase().trim()
          .replaceAll(/[‚Äû‚Äú"']/g,'"').replaceAll(/[‚Äì‚Äî-]/g,"-").replaceAll(/\s+/g," ")
          .replaceAll("√§","ae").replaceAll("√∂","oe").replaceAll("√º","ue").replaceAll("√ü","ss");
      }
      function tokenDiff(expected, got){
        const e = normDE(expected).split(" ");
        const g = normDE(got).split(" ");
        const out=[], max=Math.max(e.length,g.length);
        for(let i=0;i<max;i++){
          if(g[i]===undefined){ out.push(`<mark class="diff">${escapeHTML(e[i]||"")}</mark>`); continue; }
          if(e[i]===g[i]) out.push(`<mark class="ok">${escapeHTML(g[i])}</mark>`);
          else out.push(`<mark class="diff">${escapeHTML(g[i])}</mark>`);
        }
        return out.join(" ");
      }
      // –ø—Ä–æ—Å—Ç–∞—è –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω-–ø–æ—Ö–æ–∂–µ—Å—Ç—å
      function levenshtein(a,b){
        a=normDE(a); b=normDE(b);
        const m=a.length,n=b.length;
        const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
        for(let i=0;i<=m;i++) dp[i][0]=i;
        for(let j=0;j<=n;j++) dp[0][j]=j;
        for(let i=1;i<=m;i++){
          for(let j=1;j<=n;j++){
            const cost = a[i-1]===b[j-1]?0:1;
            dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
          }
        }
        const dist=dp[m][n];
        const maxLen=Math.max(m,n)||1;
        return Math.round((1 - dist/maxLen)*100);
      }
      function iconFor(it){ return `<i data-lucide="${ICONS[it.id]||"bookmark"}" class="lci" aria-hidden="true"></i>`; }

      /* ============== STATE ============== */
      const state = {
        shuffled:false,
        learnIndex:0,
        learnReveal:false,
        // practice
        practiceSeq:[], prIndex:0, prMistakes:[],
        // builder
        buildSeq:[], bdIndex:0, bdTokens:[], bdPick:[],
        // review (Leitner)
        reviewQueue:[], rvIndex:0,
      };

      /* ============== DAILY GOAL ============== */
      const GOAL_KEY="lek3_daily";
      const GOAL_TOTAL=20;
      function todayStr(){
        const d=new Date();
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${dd}`;
      }
      function loadGoal(){
        const all=JSON.parse(localStorage.getItem(GOAL_KEY)||"{}");
        const day=todayStr();
        if(!all[day]) all[day]={done:0,total:GOAL_TOTAL};
        localStorage.setItem(GOAL_KEY, JSON.stringify(all));
        return all[day];
      }
      function saveGoal(dayObj){
        const all=JSON.parse(localStorage.getItem(GOAL_KEY)||"{}");
        all[todayStr()]=dayObj;
        localStorage.setItem(GOAL_KEY, JSON.stringify(all));
      }
      function renderGoal(){
        const g=loadGoal();
        $("#goalDone").textContent=g.done;
        $("#goalTotal").textContent=g.total;
        $("#goalFill").style.width=Math.min(100, Math.round(100*g.done/(g.total||1)))+"%";
      }
      function incDaily(n=1){
        const g=loadGoal();
        g.done=Math.min(g.total, g.done+n);
        saveGoal(g); renderGoal();
      }

      /* ============== SPEECH SYNTH / VOICES ============== */
      function speak(text, lang, which){
        if(!("speechSynthesis" in window)) return alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–∑–≤—É—á–∫—É (Web Speech API).");
        const u=new SpeechSynthesisUtterance(text); u.lang=lang;
        u.rate = parseFloat($("#rate")?.value || "1.0") || 1.0;
        if(which){
          const v=speechSynthesis.getVoices().find(v=>v.name===which);
          if(v) u.voice=v;
        }else{
          const pref=speechSynthesis.getVoices().find(v=>v.lang.toLowerCase().startsWith(lang.toLowerCase()));
          if(pref) u.voice=pref;
        }
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }
      function populateVoices(){
        const voices=speechSynthesis.getVoices();
        const deVoices=voices.filter(v=>v.lang.toLowerCase().startsWith("de"));
        const ruVoices=voices.filter(v=>v.lang.toLowerCase().startsWith("ru"));
        const fill=(sel,arr)=>{ const el=$(sel); if(!el) return; const cur=el.value;
          el.innerHTML=arr.map(v=>`<option value="${v.name}">${v.name} (${v.lang})</option>`).join("");
          if(cur) el.value=cur;
        };
        fill("#voiceDE", deVoices.length?deVoices:voices);
        fill("#voiceRU", ruVoices.length?ruVoices:voices);
      }
      if("speechSynthesis" in window){ speechSynthesis.onvoiceschanged=populateVoices; setTimeout(populateVoices,0); }

      /* ============== SEARCH LIST ============== */
      function byDifficulty(it){
        const diff=$("#difficulty")?.value || "all";
        const len=it.de.length;
        if(diff==="short") return len<=22;
        if(diff==="long") return len>22;
        return true;
      }
      function renderList(){
        const term=($("#search").value||"").toLowerCase().trim();
        const host=$("#list"); host.innerHTML="";
        let items=state.shuffled?shuffle([...DATA]):[...DATA];
        for(const it of items){
          if(!byDifficulty(it)) continue;
          const hay=(it.de+" "+it.ru).toLowerCase();
          if(term && !hay.includes(term)) continue;
          const card=document.createElement("article");
          card.className="card";
          card.innerHTML=`
            ${iconFor(it)}
            <div>
              <div class="de">${it.id}. ${escapeHTML(it.de)}</div>
              <div class="ru">${escapeHTML(it.ru)}</div>
            </div>
            <div class="actions">
              <button title="–û–∑–≤—É—á–∏—Ç—å (DE)"><i data-lucide="volume" class="lci"></i></button>
              <button title="–û–∑–≤—É—á–∏—Ç—å (RU)"><i data-lucide="volume-2" class="lci"></i></button>
              <button title="–û–±—ä—è—Å–Ω–∏—Ç—å" data-exp="${it.id}"><i data-lucide="book-marked" class="lci"></i></button>
            </div>`;
          const [bDE,bRU,bEX] = card.querySelectorAll("button");
          bDE.addEventListener("click",()=>speak(it.de,"de-DE", $("#voiceDE")?.value));
          bRU.addEventListener("click",()=>speak(it.ru,"ru-RU", $("#voiceRU")?.value));
          bEX.addEventListener("click",()=>openExplain(it.id));
          host.appendChild(card);
        }
        applyLucide();
      }

      /* ============== LEARN ============== */
      function setLearn(i){
        state.learnIndex=i;
        state.learnReveal=false;
        const it = DATA[i];
        $("#learnFront").textContent = `${it.id}. ${it.de}`;
        $("#learnBack").textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥¬ª";
        $("#learnExplain").onclick=()=>openExplain(it.id);
      }
      function renderLearn(){ setLearn(state.learnIndex); }
      $("#learnReveal").addEventListener("click", ()=>{ const it=DATA[state.learnIndex]; $("#learnBack").textContent=it.ru; });
      $("#learnSpeakDE").addEventListener("click", ()=> speak(DATA[state.learnIndex].de,"de-DE", $("#voiceDE")?.value));
      $("#learnSpeakRU").addEventListener("click", ()=> speak(DATA[state.learnIndex].ru,"ru-RU", $("#voiceRU")?.value));
      $("#learnPrev").addEventListener("click", ()=>{ state.learnIndex=(state.learnIndex-1+DATA.length)%DATA.length; renderLearn(); });
      $("#learnNext").addEventListener("click", ()=>{ state.learnIndex=(state.learnIndex+1)%DATA.length; renderLearn(); });
      $("#learnExplain").addEventListener("click", ()=> openExplain(DATA[state.learnIndex].id));

      /* ============== PRACTICE (RU‚ÜíDE + voice) ============== */
      function startPractice(){
        state.practiceSeq = shuffle([...DATA]).slice(0,10);
        state.prIndex = 0;
        state.prMistakes = [];
        $("#prProgress").textContent = `0 / ${state.practiceSeq.length}`;
        $("#prMistakes").textContent = "0";
        $("#prFeedback").classList.add("hidden");
        $("#prHintBox").classList.add("hidden");
        $("#prVoice").classList.add("hidden");
        renderPractice();
      }
      function renderPractice(){
        const cur = state.practiceSeq[state.prIndex];
        $("#prTask").textContent = cur ? cur.ru : "–ì–æ—Ç–æ–≤–æ!";
        $("#prInput").value = "";
        $("#prFeedback").className = "feedback hidden";
        $("#prHintBox").classList.add("hidden");
        $("#prProgress").textContent = `${state.prIndex} / ${state.practiceSeq.length}`;
        $("#prExplain").onclick = ()=>openExplain(cur.id);
      }
      function giveHintPractice(){
        const cur = state.practiceSeq[state.prIndex];
        const words = cur.de.split(" ");
        const typed = $("#prInput").value.trim();
        const typedCount = typed ? typed.split(/\s+/).length : 0;
        const next = words[typedCount] || "";
        const hint = next ? `${words.slice(0,typedCount).join(" ")} ${next.slice(0, Math.max(1, Math.ceil(next.length*0.4)))}‚Ä¶` : cur.de.slice(0, Math.ceil(cur.de.length*0.35))+"‚Ä¶";
        $("#prHintBox").textContent = hint.trim();
        $("#prHintBox").classList.remove("hidden");
      }
      function checkPractice(){
        const cur = state.practiceSeq[state.prIndex];
        const got = $("#prInput").value;
        const good = normDE(got) === normDE(cur.de);
        const fb = $("#prFeedback");
        if(good){
          fb.className = "feedback good";
          fb.innerHTML = `<strong>–û—Ç–ª–∏—á–Ω–æ!</strong> –°–æ–≤–ø–∞–¥–∞–µ—Ç: ${escapeHTML(cur.de)}`;
          incDaily(1);
          addToLeitner(cur.id,true);
        }else{
          fb.className = "feedback badmsg";
          fb.innerHTML = `<strong>–ï—Å—Ç—å –æ—Ç–ª–∏—á–∏—è:</strong><br>${tokenDiff(cur.de, got)}<div class="tiny" style="margin-top:6px;">–≠—Ç–∞–ª–æ–Ω: ${escapeHTML(cur.de)}</div>`;
          state.prMistakes.push(cur);
          $("#prMistakes").textContent = String(state.prMistakes.length);
          addToLeitner(cur.id,false);
        }
        fb.classList.remove("hidden");
        const shown = Math.min(state.prIndex+1, state.practiceSeq.length);
        $("#prProgress").textContent = `${shown} / ${state.practiceSeq.length}`;
      }
      function nextPractice(){
        if(state.prIndex < state.practiceSeq.length-1){
          state.prIndex++;
          renderPractice();
        }else{
          const fb = $("#prFeedback");
          fb.className = "feedback";
          const errs = state.prMistakes.map(x=>`‚Äî ${escapeHTML(x.ru)} ‚Üí <b>${escapeHTML(x.de)}</b>`).join("<br>");
          fb.innerHTML = state.prMistakes.length
            ? `<strong>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —ç—Ç–∏ —Ñ—Ä–∞–∑—ã:</strong><br>${errs}`
            : `<strong>–°—É–ø–µ—Ä!</strong> –û—à–∏–±–æ–∫ –Ω–µ—Ç.`;
          fb.classList.remove("hidden");
        }
      }
      // voice input
      let recog=null, recogOn=false;
      function initRecog(){
        const R = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!R){ $("#prMic").classList.add("hidden"); return; }
        recog = new R(); recog.lang = "de-DE"; recog.interimResults=false;
        $("#prMic").classList.remove("hidden");
        recog.onresult=(e)=>{
          const t = Array.from(e.results).map(r=>r[0].transcript).join(" ");
          $("#prInput").value = t;
          const cur = state.practiceSeq[state.prIndex];
          const score = levenshtein(cur.de, t);
          const el = $("#prVoice");
          el.innerHTML = `üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: <em>${escapeHTML(t)}</em> ¬∑ –ø–æ—Ö–æ–∂–µ—Å—Ç—å: <strong>${score}%</strong>`;
          el.classList.remove("hidden");
        };
        recog.onend=()=>{ recogOn=false; $("#prMic").innerHTML='<i data-lucide="mic" class="lci"></i> –°–∫–∞–∑–∞—Ç—å'; applyLucide(); };
      }
      function toggleMic(){
        if(!recog) return;
        if(recogOn){ recog.stop(); return; }
        $("#prVoice").classList.add("hidden");
        recogOn=true; $("#prMic").innerHTML='<i data-lucide="square" class="lci"></i> –°—Ç–æ–ø'; applyLucide(); recog.start();
      }

      /* ============== BUILDER (—Å–æ–±–µ—Ä–∏ –∏–∑ —Å–ª–æ–≤) ============== */
      function startBuilder(){
        state.buildSeq = shuffle([...DATA]).slice(0,10);
        state.bdIndex=0;
        renderBuilder();
      }
      function splitTokens(s){
        // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–µ–∂–µ–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º, —Å–æ—Ö—Ä–∞–Ω—è—è ¬´Glas‚Äú¬ª –∫–∞–∫ –µ–¥–∏–Ω–∏—Ü—É
        return s.replaceAll("‚Äû","\"").replaceAll("‚Äú","\"").split(/\s+/);
      }
      function renderBuilder(){
        const cur = state.buildSeq[state.bdIndex];
        $("#bdTask").textContent = cur.ru;
        state.bdTokens = shuffle(splitTokens(cur.de));
        state.bdPick = [];
        drawTokens();
        $("#bdFeedback").classList.add("hidden");
        $("#bdExplain").onclick = ()=>openExplain(cur.id);
      }
      function drawTokens(){
        const pool=$("#bdTokens"); const ass=$("#bdAssembly");
        pool.innerHTML=""; ass.innerHTML="";
        state.bdTokens.forEach((tok,i)=>{
          const b=document.createElement("button"); b.className="token"; b.textContent=tok;
          b.addEventListener("click",()=>{ state.bdPick.push(tok); state.bdTokens.splice(i,1); drawTokens(); });
          pool.appendChild(b);
        });
        state.bdPick.forEach((tok,i)=>{
          const b=document.createElement("button"); b.className="token"; b.textContent=tok; b.title="–£–±—Ä–∞—Ç—å";
          b.addEventListener("click",()=>{ state.bdTokens.push(tok); state.bdPick.splice(i,1); drawTokens(); });
          ass.appendChild(b);
        });
      }
      function hintBuilder(){
        const cur = state.buildSeq[state.bdIndex];
        const target = splitTokens(cur.de);
        // –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–æ —Ç–µ–∫—É—â–µ–π —Å–±–æ—Ä–∫–µ
        const built = state.bdPick;
        let nextIdx = built.length;
        const nextTok = target[nextIdx] || target[0];
        // –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å –≤ –ø—É–ª–µ ‚Äî –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –µ–≥–æ –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
        const idx = state.bdTokens.findIndex(t=>normDE(t)===normDE(nextTok));
        if(idx>=0){
          const btn = $("#bdTokens").children[idx];
          btn.style.outline = "2px solid #ffe08a";
          setTimeout(()=>{ btn.style.outline=""; }, 900);
        }
      }
      function checkBuilder(){
        const cur = state.buildSeq[state.bdIndex];
        const got = state.bdPick.join(" ");
        const good = normDE(got)===normDE(cur.de);
        const fb=$("#bdFeedback");
        if(good){
          fb.className="feedback good";
          fb.innerHTML=`<strong>–û—Ç–ª–∏—á–Ω–æ!</strong> ${escapeHTML(cur.de)}`;
          incDaily(1);
          addToLeitner(cur.id,true);
        }else{
          fb.className="feedback badmsg";
          fb.innerHTML=`<strong>–ü–æ—á—Ç–∏:</strong><br>${tokenDiff(cur.de, got)}<div class="tiny" style="margin-top:6px;">–≠—Ç–∞–ª–æ–Ω: ${escapeHTML(cur.de)}</div>`;
          addToLeitner(cur.id,false);
        }
        fb.classList.remove("hidden");
      }
      function nextBuilder(){
        if(state.bdIndex < state.buildSeq.length-1){ state.bdIndex++; renderBuilder(); }
        else {
          const fb=$("#bdFeedback"); fb.className="feedback"; fb.innerHTML="<strong>–ì–æ—Ç–æ–≤–æ!</strong> –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –ü–æ–≤—Ç–æ—Ä—É –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.";
          fb.classList.remove("hidden");
        }
      }

      /* ============== QUIZ ============== */
      const quiz = { score:0, total:0 };
      function startQuiz(){
        quiz.score=0; quiz.total=0; $("#quizScore").textContent="0 / 0";
        const qs=shuffle([...DATA]).slice(0,10);
        const area=$("#quizArea"); area.innerHTML="";
        qs.forEach((q,i)=>{
          const block=document.createElement("div");
          block.className="quiz-q";
          block.innerHTML=`<div class="de"><span class="tiny">–í–æ–ø—Ä–æ—Å ${i+1}:</span> ${q.de}</div>`;
          const answers=document.createElement("div"); answers.className="answers";
          const wrongs=shuffle(DATA.filter(x=>x.id!==q.id)).slice(0,3);
          const opts=shuffle([q,...wrongs]);
          opts.forEach(opt=>{
            const btn=document.createElement("button"); btn.className="answer"; btn.textContent=opt.ru;
            btn.addEventListener("click",()=>{
              if(btn.dataset.locked) return; btn.dataset.locked="1";
              quiz.total++;
              if(opt.id===q.id){ btn.classList.add("correct"); quiz.score++; speak("–ü—Ä–∞–≤–∏–ª—å–Ω–æ","ru-RU", $("#voiceRU")?.value); incDaily(1); addToLeitner(q.id,true); }
              else { btn.classList.add("wrong"); speak("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ","ru-RU", $("#voiceRU")?.value); addToLeitner(q.id,false); }
              $("#quizScore").textContent=`${quiz.score} / ${quiz.total}`;
              [...answers.children].forEach(b=>{ if(b.textContent===q.ru) b.classList.add("correct"); b.disabled=true; });
            });
            answers.appendChild(btn);
          });
          block.appendChild(answers); area.appendChild(block);
        });
      }

      /* ============== VERBS & NUMBERS ============== */
      const VERBS = {
        m√∂chten:[ "ich m√∂chte","du m√∂chtest","er/sie/es m√∂chte","wir m√∂chten","ihr m√∂chtet","sie/Sie m√∂chten" ],
        m√∂gen:[ "ich mag","du magst","er/sie/es mag","wir m√∂gen","ihr m√∂gt","sie/Sie m√∂gen" ],
        wissen:[ "ich wei√ü","du wei√üt","er/sie/es wei√ü","wir wissen","ihr wisst","sie/Sie wissen" ],
        handeln:[ "ich handle","du handelst","er/sie/es handelt","wir handeln","ihr handelt","sie/Sie handeln" ],
      };
      function renderVerbs(){
        const host=$("#verbs"); host.innerHTML="";
        const box=document.createElement("div"); box.className="panel";
        box.innerHTML = Object.entries(VERBS).map(([verb,forms])=>`
          <div class="panel" style="margin-bottom:10px;">
            <h3 style="margin:0 0 8px 0;font-size:18px;">${verb}</h3>
            ${forms.map(f=>`
              <div class="row" style="justify-content:space-between;">
                <div>${f}</div>
                <button class="speak" data-t="${f}" title="–û–∑–≤—É—á–∏—Ç—å"><i data-lucide="volume" class="lci"></i></button>
              </div>`).join("")}
          </div>`).join("");
        host.appendChild(box);
        host.querySelectorAll("button.speak").forEach(b=> b.addEventListener("click",()=>speak(b.dataset.t,"de-DE", $("#voiceDE")?.value)));
        applyLucide();
      }

      const BASE = {0:"null",1:"eins",2:"zwei",3:"drei",4:"vier",5:"f√ºn—Ñ",6:"sechs",7:"sieben",8:"acht",9:"neun",10:"zehn",
        11:"elf",12:"zw√∂lf",13:"dreizehn",14:"vierzehn",15:"f√ºnfzehn",16:"sechzehn",17:"siebzehn",18:"achtzehn",19:"neunzehn",
        20:"zwanzig",30:"drei√üig",40:"vierzig",50:"f√ºnfzig",60:"sechzig",70:"siebzig",80:"achtzig",90:"neunzig",100:"hundert" };
      function germanNumber(n){
        if(n in BASE) return BASE[n];
        if(n<100){
          const t=Math.floor(n/10)*10,u=n%10;
          const unit=(u===1?"ein":"")||BASE[u];
          return `${unit||""}${u===1?"":"und"}${BASE[t]}`.replace("einsund","einund");
        }
        return "";
      }
      let nums=Array.from({length:101},(_,i)=>i), numsShuffled=false;
      function renderNumbers(){
        const q=($("#numSearch").value||"").toLowerCase().trim();
        const arr=numsShuffled?shuffle(nums):nums;
        const host=$("#numbers"); host.innerHTML="";
        arr.forEach(n=>{
          const word=germanNumber(n);
          if(q && !(String(n).includes(q) || word.toLowerCase().includes(q))) return;
          const card=document.createElement("div"); card.className="panel";
          card.innerHTML=`<div style="font-size:22px;font-weight:800;">${n}</div>
                          <div style="color:var(--muted)">${word}</div>
                          <div class="row" style="margin-top:6px;">
                            <button class="speakN" data-t="${word}" title="–û–∑–≤—É—á–∏—Ç—å"><i data-lucide="volume" class="lci"></i></button>
                          </div>`;
          card.querySelector(".speakN").addEventListener("click",()=>speak(word,"de-DE", $("#voiceDE")?.value));
          host.appendChild(card);
        });
        applyLucide();
      }

      /* ============== EXPLAIN DIALOG ============== */
      function openExplain(id){
        const it = DATA.find(x=>x.id===id);
        const ex = EXPLAIN[id] || {};
        $("#explainBody").innerHTML = `
          <div><strong>–§—Ä–∞–∑–∞:</strong> ${escapeHTML(it.de)}</div>
          <div><strong>–ü–µ—Ä–µ–≤–æ–¥:</strong> ${escapeHTML(it.ru)}</div>
          <div class="modal-section"><strong>–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:</strong> ${escapeHTML(ex.gram||"‚Äî")}</div>
          <div class="modal-section"><strong>–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ:</strong> ${escapeHTML(ex.alt||"‚Äî")}</div>
          <div class="modal-section"><strong>–°–ª–æ–≤–∞:</strong> ${escapeHTML(ex.vocab||"‚Äî")}</div>
        `;
        $("#explainDialog").showModal(); applyLucide();
      }

      /* ============== LEITNER SPACED REPETITION ============== */
      const LKEY="lek3_leitner";
      const BOX_INTERVALS=[1,2,4,7,15]; // –¥–Ω–∏
      function loadLeitner(){
        return JSON.parse(localStorage.getItem(LKEY)||"{}");
      }
      function saveLeitner(obj){ localStorage.setItem(LKEY, JSON.stringify(obj)); }
      function addToLeitner(id, correct){
        const store=loadLeitner();
        const rec=store[id] || {box:1, due:Date.now()};
        if(correct){
          rec.box = Math.min(5, (rec.box||1)+1);
        } else {
          rec.box = 1;
        }
        const days = BOX_INTERVALS[rec.box-1] || 1;
        rec.due = Date.now() + days*24*60*60*1000;
        store[id]=rec; saveLeitner(store);
        renderReviewDue();
      }
      function renderReviewDue(){
        const store=loadLeitner();
        const today = Date.now();
        const due = Object.values(store).filter(r=>r.due<=today).length;
        $("#rvDue").textContent = due;
        const stats = [1,2,3,4,5].map(b=>{
          const cnt=Object.values(store).filter(r=>r.box===b).length;
          return `B${b}:${cnt}`;
        }).join(" ¬∑ ");
        $("#rvStats").textContent = stats || "‚Äî";
      }
      function startReview(){
        const store=loadLeitner();
        const today=Date.now();
        const ids=Object.entries(store).filter(([_,r])=>r.due<=today).map(([id])=>Number(id));
        state.reviewQueue = ids.length ? ids : shuffle(DATA.map(d=>d.id)).slice(0,5); // –µ—Å–ª–∏ –Ω–µ—Ç ¬´–¥–æ–ª–∂–Ω—ã—Ö¬ª ‚Äî –¥–∞–¥–∏–º 5 —Å–ª—É—á–∞–π–Ω—ã—Ö
        state.rvIndex = 0;
        renderReviewCard();
      }
      function renderReviewCard(){
        const id = state.reviewQueue[state.rvIndex];
        const it = DATA.find(x=>x.id===id);
        if(!it){ $("#rvTask").textContent="–ì–æ—Ç–æ–≤–æ!"; return; }
        $("#rvTask").textContent = it.ru;
        $("#rvInput").value = "";
        $("#rvFeedback").classList.add("hidden");
      }
      function checkReview(){
        const id = state.reviewQueue[state.rvIndex];
        const it = DATA.find(x=>x.id===id);
        const got = $("#rvInput").value;
        const ok = normDE(got)===normDE(it.de);
        const fb=$("#rvFeedback");
        if(ok){
          fb.className="feedback good";
          fb.innerHTML=`–í–µ—Ä–Ω–æ: ${escapeHTML(it.de)}`;
          incDaily(1);
          addToLeitner(it.id,true);
        } else {
          fb.className="feedback badmsg";
          fb.innerHTML=`–ï—Å—Ç—å –æ—Ç–ª–∏—á–∏—è:<br>${tokenDiff(it.de, got)}<div class="tiny" style="margin-top:6px;">–≠—Ç–∞–ª–æ–Ω: ${escapeHTML(it.de)}</div>`;
          addToLeitner(it.id,false);
        }
        fb.classList.remove("hidden");
        renderReviewDue();
      }
      function hardReview(){
        const id = state.reviewQueue[state.rvIndex];
        addToLeitner(id,false);
        renderReviewDue();
      }
      function nextReview(){
        if(state.rvIndex < state.reviewQueue.length-1){ state.rvIndex++; renderReviewCard(); }
        else { $("#rvTask").textContent="–ü–æ–≤—Ç–æ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω!"; }
      }

      /* ============== SETTINGS / TABS / EVENTS ============== */
      function activateTab(name){
        $$(".tab").forEach(x=>{ const on=x.dataset.tab===name; x.classList.toggle("active",on); x.setAttribute("aria-selected",on?"true":"false"); });
        $$(".tab-panel").forEach(p=>p.classList.add("hidden"));
        const pane=$("#tab-"+name); if(pane) pane.classList.remove("hidden");
        if(name==="learn") renderLearn();
        if(name==="practice"){ startPractice(); }
        if(name==="build"){ startBuilder(); }
        if(name==="quiz"){ /* –∂–¥—ë–º —Å—Ç–∞—Ä—Ç */ }
        if(name==="review"){ renderReviewDue(); }
        if(name==="verbs") renderVerbs();
        if(name==="numbers") renderNumbers();
        applyLucide();
      }
      document.querySelector("nav.tabs").addEventListener("click",(e)=>{
        const tab=e.target.closest(".tab"); if(!tab) return; activateTab(tab.dataset.tab);
      });

      // search & shuffle
      $("#search").addEventListener("input", renderList);
      $("#shuffle").addEventListener("click", ()=>{ state.shuffled=!state.shuffled; renderList(); renderLearn(); });

      // settings
      $("#openSettings").addEventListener("click", ()=> $("#settingsDialog").showModal());
      $("#closeSettings").addEventListener("click", ()=> $("#settingsDialog").close());
      $("#difficulty")?.addEventListener("change", ()=>{ renderList(); renderLearn(); });

      // explain dialog close
      $("#closeExplain").addEventListener("click", ()=> $("#explainDialog").close());

      // practice events
      $("#prHint").addEventListener("click", giveHintPractice);
      $("#prCheck").addEventListener("click", checkPractice);
      $("#prNext").addEventListener("click", nextPractice);
      $("#prExplain").addEventListener("click", ()=> {
        const cur = state.practiceSeq[state.prIndex]; openExplain(cur.id);
      });
      $("#prMic").addEventListener("click", toggleMic);

      // builder events
      $("#bdHint").addEventListener("click", hintBuilder);
      $("#bdClear").addEventListener("click", ()=>{ state.bdPick=[]; drawTokens(); });
      $("#bdCheck").addEventListener("click", checkBuilder);
      $("#bdNext").addEventListener("click", nextBuilder);
      $("#bdExplain").addEventListener("click", ()=> {
        const cur = state.buildSeq[state.bdIndex]; openExplain(cur.id);
      });

      // quiz
      $("#quizStart").addEventListener("click", startQuiz);

      // review
      $("#rvStart").addEventListener("click", startReview);
      $("#rvCheck").addEventListener("click", checkReview);
      $("#rvNext").addEventListener("click", nextReview);
      $("#rvHard").addEventListener("click", hardReview);

      // verbs cloze
      function norm(s){ return (s||"").toLowerCase().trim().replaceAll("√∂","oe").replaceAll("√§","ae").replaceAll("√º","ue").replaceAll("√ü","ss"); }
      $("#moeCheck").addEventListener("click", ()=>{
        $$("#tab-verbs input").forEach(inp=>{
          inp.classList.remove("ok","bad");
          const want=(inp.dataset.a||"").split("|").map(norm);
          const got=norm(inp.value);
          inp.classList.add(want.includes(got)?"ok":"bad");
        });
      });
      $("#moeShow").addEventListener("click", ()=>{
        $$("#tab-verbs input").forEach(inp=>{
          const ans=(inp.dataset.a||"").split("|")[0].replace("oe","√∂");
          inp.value=ans; inp.classList.remove("bad"); inp.classList.add("ok");
        });
      });

      // numbers
      $("#numSearch").addEventListener("input", renderNumbers);
      $("#numShuffle").addEventListener("click", ()=>{ numsShuffled=!numsShuffled; renderNumbers(); });

      // init voice recognition if available
      initRecog();

      /* ============== INITIAL RENDER ============== */
      renderList(); renderLearn(); renderGoal(); applyLucide();
    </script>
  </body>
</html>
