<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lektion 3</title>
<meta name="description" content="Lerne 20 wichtige S√§tze (Deutsch ‚Üî Russisch) mit Flashcards, Quiz & Sprachausgabe. Alles offline in einer Datei." />
<style>
  :root{
    --bg:#000; --panel:#0a0a0a; --panel-2:#0a0a0a; --text:#f5f5f5; --muted:#a9a9a9; --border:#1f1f1f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}
  .wrap{max-width:720px; margin-inline:auto; padding:16px; padding-bottom:96px}

  /* Header */
  header{display:grid; gap:8px; grid-template-columns:1fr}
  .title{font-size: clamp(20px, 5vw, 28px); font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
  .subtitle{color:var(--muted); font-size:14px}

  /* Panels & Cards */
  .panel{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px}
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; display:grid; grid-template-columns: 44px 1fr auto; gap:10px; align-items:center}
  .icon{font-size:28px; filter: grayscale(1) contrast(1.15);}
  .img{width:32px; height:32px; border-radius:8px; object-fit:cover; border:1px solid var(--border); background:#111}
  .de{font-weight:700; font-size: 18px}
  .ru{color:var(--muted); margin-top:2px; font-size:15px}

  /* Controls */
  .controls{display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px}
  .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  input, select, button, .pill{appearance:none; background:#0b0b0b; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:12px 14px; font:inherit; min-height:48px}
  input[type="number"]{width:84px}
  button{cursor:pointer}
  button:active{transform: translateY(1px)}
  .btn-accent{border-color:#fff}
  .actions{display:flex; gap:6px; flex-wrap:wrap}
  .tiny{font-size:12px; color:var(--muted)}
  .hidden{display:none !important}

  /* Tabs ‚Äî icon only; sticky top for quick access on phones */
  .tabs{position:sticky; top:0; z-index:50; background:rgba(0,0,0,.85); backdrop-filter: blur(6px); border-bottom:1px solid var(--border); margin-left:-16px; margin-right:-16px; padding:8px 16px; display:flex; gap:8px; justify-content:center}
  .tab{width:56px; height:56px; display:grid; place-items:center; border:1px solid var(--border); border-radius:14px; font-size:24px; background:#0a0a0a}
  .tab.active{outline:2px solid #fff; outline-offset:2px}

  /* Bottom nav for phones */
  .bottom-nav{position:fixed; left:0; right:0; bottom:0; z-index:60; background:rgba(0,0,0,.9); border-top:1px solid var(--border); padding:8px max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); padding-bottom:calc(8px + env(safe-area-inset-bottom)); display:flex; gap:8px; justify-content:space-between}
  .bottom-nav .tab{flex:1; border-radius:12px}

  /* Flashcards */
  .flash{display:grid; gap:12px}
  .flash-card{background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:22px; text-align:center; min-height:180px; display:grid; place-items:center; gap:6px; position:relative}
  .flash-card .face{font-size:22px; font-weight:800}
  .flash-card .sub{color:var(--muted); font-size:16px}
  .flash-card .big-emoji{font-size:36px; position:absolute; top:12px; left:12px; filter:grayscale(1) contrast(1.1)}
  .flash-card .big-img{position:absolute; top:12px; left:12px; width:44px; height:44px; border-radius:10px; object-fit:cover; border:1px solid var(--border); background:#111}

  /* Quiz */
  .quiz{display:grid; gap:10px}
  .quiz-q{background:var(--panel); border:1px solid var(--border); padding:14px; border-radius:14px}
  .answers{display:grid; gap:8px}
  .answer{padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0b0b0b}
  .answer.correct{outline:2px solid #eaeaea}
  .answer.wrong{outline:2px dashed #666}
  .score{font-weight:700}

  /* Verbs */
  .vgrid{display:grid; grid-template-columns:1fr; gap:12px}
  .vcard{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px}
  .vcard h3{margin:0 0 8px 0; font-size:18px}
  .vcard table{width:100%; border-collapse:collapse}
  .vcard td{padding:8px 6px; border-bottom:1px solid var(--border)}
  .vcard tr:last-child td{border-bottom:0}
  .cloze{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; display:grid; gap:8px}
  .cloze .line{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .cloze input{width:120px; text-align:center}
  .ok{outline:2px solid #d0ffd4}
  .bad{outline:2px solid #ffb3c1}

  /* Numbers */
  .numbers-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
  .ncard{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; display:grid; gap:6px}
  .nnum{font-size:22px; font-weight:800}
  .nword{color:var(--muted)}

  /* A11y & mobile ergonomics */
  @media (pointer:coarse){
    .actions button{min-width:56px; min-height:44px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">üìò Lektion 3 ‚Äî DE‚ÄìRU Phrase Trainer</div>
        <div class="subtitle">20 wichtige S√§tze ¬∑ –û–∑–≤—É—á–∫–∞ ¬∑ –ö–∞—Ä—Ç–∏–Ω–∫–∏‚Äë–ø–æ–¥—Å–∫–∞–∑–∫–∏ ¬∑ –§–ª–µ—à‚Äë–∫–∞—Ä—Ç–æ—á–∫–∏ ¬∑ –¢–µ—Å—Ç</div>
      </div>
      <nav class="tabs" role="tablist" aria-label="–†–µ–∂–∏–º—ã">
  <button class="tab active" data-tab="list" role="tab" aria-selected="true" title="–°–ø–∏—Å–æ–∫" aria-label="–°–ø–∏—Å–æ–∫">üìö</button>
  <button class="tab" data-tab="flash" role="tab" aria-selected="false" title="–ö–∞—Ä—Ç–æ—á–∫–∏" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∏">üÉè</button>
  <button class="tab" data-tab="quiz" role="tab" aria-selected="false" title="–¢–µ—Å—Ç" aria-label="–¢–µ—Å—Ç">üìù</button>
  <button class="tab" data-tab="verbs" role="tab" aria-selected="false" title="–ì–ª–∞–≥–æ–ª—ã" aria-label="–ì–ª–∞–≥–æ–ª—ã">üî§</button>
  <button class="tab" data-tab="numbers" role="tab" aria-selected="false" title="–ß–∏—Å–ª–∞" aria-label="–ß–∏—Å–ª–∞">üî¢</button>
</nav>
    </header>

    <section class="controls panel" aria-label="Einstellungen">
      <div class="row">
        <label class="pill">üîç <span class="sr-only">–ü–æ–∏—Å–∫</span>
          <input id="search" type="text" placeholder="–ù–∞–π—Ç–∏: —Å–ª–æ–≤–æ –Ω–∞ –Ω–µ–º./—Ä—É—Å." aria-label="–ü–æ–∏—Å–∫" />
        </label>
        <button id="shuffle" class="btn-accent">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
        <label class="pill">üéØ –°–ª–æ–∂–Ω–æ—Å—Ç—å
          <select id="difficulty" aria-label="–°–ª–æ–∂–Ω–æ—Å—Ç—å">
            <option value="all">–í—Å–µ</option>
            <option value="short">–ö–æ—Ä–æ—Ç–∫–∏–µ</option>
            <option value="long">–î–ª–∏–Ω–Ω—ã–µ</option>
          </select>
        </label>
        <label class="pill">üîà –ì–æ–ª–æ—Å (DE)
          <select id="voiceDE" aria-label="–ì–æ–ª–æ—Å –¥–ª—è –Ω–µ–º–µ—Ü–∫–æ–≥–æ"></select>
        </label>
        <label class="pill">üîâ –ì–æ–ª–æ—Å (RU)
          <select id="voiceRU" aria-label="–ì–æ–ª–æ—Å –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ"></select>
        </label>
        <label class="pill">üê¢ –°–∫–æ—Ä–æ—Å—Ç—å
          <input id="rate" type="number" min="0.6" max="1.4" step="0.1" value="1.0" aria-label="–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏" />
        </label>
      </div>
      <div class="row">
        <button id="resetProgress">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        <button id="exportData">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç (JSON)</button>
        <input type="file" id="importData" accept="application/json" class="hidden" />
        <button id="importBtn">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç</button>
      </div>
    </section>

    <!-- LIST MODE -->
    <section id="tab-list" class="tab-panel" role="tabpanel" aria-labelledby="–°–ø–∏—Å–æ–∫">
      <div id="list" class="grid" aria-live="polite"></div>
    </section>

    <!-- FLASHCARDS MODE -->
    <section id="tab-flash" class="tab-panel hidden" role="tabpanel" aria-labelledby="–ö–∞—Ä—Ç–æ—á–∫–∏">
      <div class="flash">
        <div class="flash-card" id="flashCard" tabindex="0" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∞ ‚Äî –Ω–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å">
          <div class="big-emoji" id="flashEmoji">üí¨</div>
          <div class="face" id="flashFront">‚Ä¶</div>
          <div class="sub" id="flashBack">¬†</div>
        </div>
        <div class="flex">
          <button id="flashPrev">‚óÄÔ∏è –ù–∞–∑–∞–¥</button>
          <button id="flashSpeakDE" class="btn-accent">üîà –ù–µ–º–µ—Ü–∫–∏–π</button>
          <button id="flashSpeakRU">üîâ –†—É—Å—Å–∫–∏–π</button>
          <button id="flashReveal">üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
          <button id="flashNext">–í–ø–µ—Ä—ë–¥ ‚ñ∂Ô∏è</button>
          <button id="flashKnown">‚úÖ –ó–Ω–∞—é</button>
        </div>
        <div class="tiny">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–∂–º–∏—Ç–µ –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å; ‚Üê/‚Üí –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.</div>
      </div>
    </section>

    <!-- QUIZ MODE -->
    <section id="tab-quiz" class="tab-panel hidden" role="tabpanel" aria-labelledby="–¢–µ—Å—Ç">
      <div class="quiz">
        <div class="flex">
          <button id="quizStart" class="btn-accent">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç (10 –≤–æ–ø—Ä–æ—Å–æ–≤)</button>
          <div class="pill">üìà –†–µ–∑—É–ª—å—Ç–∞—Ç: <span id="quizScore" class="score">0 / 0</span></div>
        </div>
        <div id="quizArea"></div>
      </div>
    </section>
    <!-- VERBS MODE -->
    <section id="tab-verbs" class="tab-panel hidden" role="tabpanel" aria-labelledby="–ì–ª–∞–≥–æ–ª—ã">
      <div class="vgrid" id="verbs"></div>
      <div class="cloze" id="moechtenCloze">
        <strong>–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Ñ–æ—Ä–º—É –≥–ª–∞–≥–æ–ª–∞ ‚Äûm√∂chten‚Äú:</strong>
        <div class="line"><span>1.</span> <strong>Ich</strong> <input data-a="moechte|m√∂chte"> ein Eis. <span class="tiny">(–Ø —Ö–æ—á—É –º–æ—Ä–æ–∂–µ–Ω–æ–µ.)</span></div>
        <div class="line"><span>2.</span> <strong>Du</strong> <input data-a="moechtest|m√∂chtest"> einen Kaffee? <span class="tiny">(–¢—ã —Ö–æ—á–µ—à—å –∫–æ—Ñ–µ?)</span></div>
        <div class="line"><span>3.</span> <strong>Er</strong> <input data-a="moechte|m√∂chte"> ein Buch lesen. <span class="tiny">(–û–Ω —Ö–æ—á–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É.)</span></div>
        <div class="line"><span>4.</span> <strong>Wir</strong> <input data-a="moechten|m√∂chten"> ein Zimmer mit Meerblick. <span class="tiny">(–ú—ã —Ö–æ—Ç–∏–º –Ω–æ–º–µ—Ä —Å –≤–∏–¥–æ–º –Ω–∞ –º–æ—Ä–µ.)</span></div>
        <div class="line"><span>5.</span> <strong>Ihr</strong> <input data-a="moechtet|m√∂chtet"> eine Cola? <span class="tiny">(–í—ã —Ö–æ—Ç–∏—Ç–µ –∫–æ–ª—É?)</span></div>
        <div class="line"><span>6.</span> <strong>Sie</strong> <input data-a="moechten|m√∂chten"> ein Ticket nach Berlin. <span class="tiny">(–û–Ω–∏ —Ö–æ—Ç—è—Ç –±–∏–ª–µ—Ç –¥–æ –ë–µ—Ä–ª–∏–Ω–∞.)</span></div>
        <div class="row">
          <button id="moeCheck" class="btn-accent">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button id="moeShow">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
        </div>
      </div>
    </section>

    <!-- NUMBERS MODE -->
    <section id="tab-numbers" class="tab-panel hidden" role="tabpanel" aria-labelledby="–ß–∏—Å–ª–∞">
      <div class="panel">
        <div class="row">
          <label class="pill">üîé <span class="sr-only">–ü–æ–∏—Å–∫ —á–∏—Å–ª–∞</span>
            <input id="numSearch" type="text" placeholder="–ü–æ–∏—Å–∫: 21 / einundzwanzig" aria-label="–ü–æ–∏—Å–∫ —á–∏—Å–ª–∞"/>
          </label>
          <button id="numShuffle">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
        </div>
      </div>
      <div id="numbers" class="numbers-grid" aria-live="polite"></div>
    </section>

    <div class="spacer"></div>
    <footer class="tiny">–°–¥–µ–ª–∞–Ω–æ –¥–ª—è –õ–µ–∫—Ü–∏–∏ 3. –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. ‚ú®</footer>
    <nav class="bottom-nav" role="tablist" aria-label="–ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
      <button class="tab active" data-tab="list" role="tab" aria-selected="true" title="–°–ø–∏—Å–æ–∫" aria-label="–°–ø–∏—Å–æ–∫">üìö</button>
      <button class="tab" data-tab="flash" role="tab" aria-selected="false" title="–ö–∞—Ä—Ç–æ—á–∫–∏" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∏">üÉè</button>
      <button class="tab" data-tab="quiz" role="tab" aria-selected="false" title="–¢–µ—Å—Ç" aria-label="–¢–µ—Å—Ç">üìù</button>
      <button class="tab" data-tab="verbs" role="tab" aria-selected="false" title="–ì–ª–∞–≥–æ–ª—ã" aria-label="–ì–ª–∞–≥–æ–ª—ã">üî§</button>
      <button class="tab" data-tab="numbers" role="tab" aria-selected="false" title="–ß–∏—Å–ª–∞" aria-label="–ß–∏—Å–ª–∞">üî¢</button>
    </nav>
  </div>

<script>
const DATA = [
  {id:1, icon:"üíÉ", de:"Wir m√∂chten heute tanzen.", ru:"–ú—ã —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ç–∏–º —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å."},
  {id:2, icon:"üçï", de:"Ich mag Pizza essen.", ru:"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –ø–∏—Ü—Ü–∞."},
  {id:3, icon:"üá©üá™", de:"Ich m√∂chte in Deutschland arbeiten.", ru:"–Ø —Ö–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ì–µ—Ä–º–∞–Ω–∏–∏."},
  {id:4, icon:"‚ú®", de:"Du bist sehr sch√∂n.", ru:"–¢—ã –æ—á–µ–Ω—å –∫—Ä–∞—Å–∏–≤–∞—è(—ã–π)."},
  {id:5, icon:"üë¶", de:"Mein Bruder ist klein.", ru:"–ú–æ—è –±—Ä–∞—Ç –º–∞–ª–µ–Ω—å–∫–∏–π."},
  {id:6, icon:"üó∫Ô∏è", de:"Meine Eltern sind in Naryn.", ru:"–ú–æ–∏ —Ä–æ–¥–∏—Ç–µ–ª–∏ –≤ –ù–∞—Ä—ã–Ω–µ."},
  {id:7, icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶", de:"Ich habe gro√üe Familie.", ru:"–£ –º–µ–Ω—è –±–æ–ª—å—à–∞—è —Å–µ–º—å—è."},
  {id:8, icon:"üßí", de:"Er hat 2 Kinder.", ru:"–£ –Ω–µ–≥–æ 2 –¥–µ—Ç–µ–π."},
  {id:9, icon:"üìö", de:"Wir haben viele Hausaufgaben.", ru:"–£ –Ω–∞—Å –º–Ω–æ–≥–æ –¥–æ–º.–∑–∞–¥–∞–Ω–∏–π."},
  {id:10, icon:"ü™™", de:"Mein Name ist Aizhan.", ru:"–ú–æ—ë –∏–º—è –ê–π–∂–∞–Ω."},
  {id:11, icon:"üèôÔ∏è", de:"Bist du aus Osch?", ru:"–¢—ã –∏–∑ –û—à–∞?"},
  {id:12, icon:"ü§∑", de:"Ich wei√ü nicht.", ru:"–Ø –Ω–µ –∑–Ω–∞—é."},
  {id:13, icon:"ü•õ", de:"Wir wissen das Wort \"Glas\" nicht.", ru:"–ú—ã –Ω–µ –∑–Ω–∞–µ–º —Å–ª–æ–≤–æ \"—Å—Ç–∞–∫–∞–Ω\"."},
  {id:14, icon:"ü§ï", de:"Mein Kopf tut mir weh.", ru:"–£ –º–µ–Ω—è –±–æ–ª–∏—Ç –≥–æ–ª–æ–≤–∞."},
  {id:15, icon:"üìñ", de:"Magst du Deutsch lernen?", ru:"–¢–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —É—á–∏—Ç—å –Ω–µ–º–µ—Ü–∫–∏–π?"},
  {id:16, icon:"üïí", de:"Hast du heute Freizeit?", ru:"–£ —Ç–µ–±—è –µ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è?"},
  {id:17, icon:"ü§í", de:"Sind Sie krank?", ru:"–í—ã –±–æ–ª–µ–µ—Ç–µ? / –í—ã –±–æ–ª—å–Ω—ã?"},
  {id:18, icon:"üò™", de:"Ich bin ein bisschen m√ºde.", ru:"–Ø –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞–≤—à–∏–π."},
  {id:19, icon:"‚ùì", de:"Habt ihr noch Fragen?", ru:"–£ –≤–∞—Å –µ—Å—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã?"},
  {id:20, icon:"‚è≥", de:"Ich habe keine Zeit.", ru:"–£ –º–µ–Ω—è –Ω–µ—Ç—É –≤—Ä–µ–º–µ–Ω–∏."}
];

const VERBS = {
  "m√∂chten": ["ich m√∂chte","du m√∂chtest","er/sie/es m√∂chte","wir m√∂chten","ihr m√∂chtet","sie/Sie m√∂chten"],
  "m√∂gen": ["ich mag","du magst","er/sie/es mag","wir m√∂gen","ihr m√∂gt","sie/Sie m√∂gen"],
  "wissen": ["ich wei√ü","du wei√üt","er/sie/es wei√ü","wir wissen","ihr wisst","sie/Sie wissen"],
  "handeln": ["ich handle","du handelst","er/sie/es handelt","wir handeln","ihr handelt","sie/Sie handeln"],
};

// ‚Äî‚Äî‚Äî‚Äî‚Äî Utilities ‚Äî‚Äî‚Äî‚Äî‚Äî
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const state = {
  list: [...DATA],
  shuffled: false,
  known: new Set(JSON.parse(localStorage.getItem('lek3_known')||'[]')),
  imgs: JSON.parse(localStorage.getItem('lek3_imgs')||'{}'),
  quiz: {score:0, total:0},
  voices: {de:null, ru:null},
  rate: 1.0,
};
function saveKnown(){ localStorage.setItem('lek3_known', JSON.stringify([...state.known])); }
function saveImgs(){ localStorage.setItem('lek3_imgs', JSON.stringify(state.imgs)); }
function speak(text, lang, which){
  if(!('speechSynthesis' in window)) return alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–∑–≤—É—á–∫—É (Web Speech API).');
  const u = new SpeechSynthesisUtterance(text); u.lang = lang; u.rate = state.rate || 1.0;
  if(which){ const v = speechSynthesis.getVoices().find(v => v.name === which); if(v) u.voice = v; }
  else { const pref = speechSynthesis.getVoices().find(v=> v.lang.toLowerCase().startsWith(lang.toLowerCase())); if(pref) u.voice = pref; }
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
function byDifficulty(item){ const diff = $('#difficulty').value; const len = item.de.length; if(diff==='short') return len <= 22; if(diff==='long') return len > 22; return true; }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function escapeHTML(s){ return s.replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

// ‚Äî‚Äî‚Äî‚Äî‚Äî Render List ‚Äî‚Äî‚Äî‚Äî‚Äî
function renderList(){
  const term = ($('#search').value||'').trim().toLowerCase();
  const container = $('#list'); container.innerHTML = '';
  let items = [...DATA]; if(state.shuffled) items = shuffle(items);
  for(const it of items){
    if(!byDifficulty(it)) continue;
    const hay = (it.de + ' ' + it.ru).toLowerCase(); if(term && !hay.includes(term)) continue;

    const left = state.imgs[it.id] ? `<img class="img" src="${state.imgs[it.id]}" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è ${escapeHTML(it.de)}">` : `<div class=\"icon\" aria-hidden=\"true\">${it.icon}</div>`;
    const card = document.createElement('article'); card.className = 'card';
    card.innerHTML = `
      ${left}
      <div>
        <div class="de">${it.id}. ${escapeHTML(it.de)}</div>
        <div class="ru">${escapeHTML(it.ru)}</div>
      </div>
      <div class="actions">
        <button title="–ù–µ–º–µ—Ü–∫–∏–π" aria-label="–û–∑–≤—É—á–∏—Ç—å –ø–æ-–Ω–µ–º–µ—Ü–∫–∏">üîà DE</button>
        <button title="–†—É—Å—Å–∫–∏–π" aria-label="–û–∑–≤—É—á–∏—Ç—å –ø–æ-—Ä—É—Å—Å–∫–∏">üîâ RU</button>
        <button title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ—Ä–∞–∑—É">üìã</button>
        <button title="–ö–∞—Ä—Ç–∏–Ω–∫–∞" aria-label="–î–æ–±–∞–≤–∏—Ç—å/—Å–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">üñºÔ∏è</button>
        <button title="–ó–Ω–∞—é / –Ω–µ –∑–Ω–∞—é" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã—É—á–µ–Ω–æ">${state.known.has(it.id)?'‚úÖ':'‚¨úÔ∏è'}</button>
      </div>`;

    const [btnDE, btnRU, btnCopy, btnImg, btnKnown] = card.querySelectorAll('button');
    btnDE.addEventListener('click', ()=> speak(it.de, 'de-DE', $('#voiceDE').value));
    btnRU.addEventListener('click', ()=> speak(it.ru, 'ru-RU', $('#voiceRU').value));
    btnCopy.addEventListener('click', ()=> { navigator.clipboard.writeText(`${it.de} ‚Äî ${it.ru}`); btnCopy.textContent='‚úîÔ∏è'; setTimeout(()=>btnCopy.textContent='üìã', 900); });
    btnImg.addEventListener('click', ()=> setImageFor(it.id));
    btnKnown.addEventListener('click', ()=>{ toggleKnown(it.id); btnKnown.textContent = state.known.has(it.id)?'‚úÖ':'‚¨úÔ∏è'; });

    container.appendChild(card);
  }
}
function setImageFor(id){
  const cur = state.imgs[id]||'';
  const url = prompt('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (https://...)–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç–æ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å.', cur);
  if(url===null) return; // canceled
  if(url.trim()===''){ delete state.imgs[id]; }
  else { state.imgs[id] = url.trim(); }
  saveImgs(); renderList(); renderFlash();
}
function toggleKnown(id){ if(state.known.has(id)) state.known.delete(id); else state.known.add(id); saveKnown(); }

// ‚Äî‚Äî‚Äî‚Äî‚Äî Flashcards ‚Äî‚Äî‚Äî‚Äî‚Äî
let flashIndex = 0; let flashReveal=false; let flashSequence=[...DATA];
function renderFlash(){ flashSequence = state.shuffled ? shuffle([...DATA]) : [...DATA]; flashIndex = 0; flashReveal = false; updateFlash(); }
function updateFlash(){
  const it = flashSequence[flashIndex];
  const img = state.imgs[it.id];
  const badge = $('#flashEmoji');
  if(img){ badge.innerHTML = `<img class='big-img' src='${img}' alt=''>`; }
  else { badge.textContent = it.icon; }
  $('#flashFront').textContent = `${it.id}. ${it.de}`;
  $('#flashBack').textContent = flashReveal ? it.ru : '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
}
$('#flashCard').addEventListener('click', ()=>{ flashReveal = !flashReveal; updateFlash(); });
$('#flashReveal').addEventListener('click', ()=>{ flashReveal = true; updateFlash(); });
$('#flashPrev').addEventListener('click', ()=>{ flashIndex = (flashIndex-1+flashSequence.length)%flashSequence.length; flashReveal=false; updateFlash(); });
$('#flashNext').addEventListener('click', ()=>{ flashIndex = (flashIndex+1)%flashSequence.length; flashReveal=false; updateFlash(); });
$('#flashSpeakDE').addEventListener('click', ()=> speak(flashSequence[flashIndex].de,'de-DE',$('#voiceDE').value));
$('#flashSpeakRU').addEventListener('click', ()=> speak(flashSequence[flashIndex].ru,'ru-RU',$('#voiceRU').value));
$('#flashKnown').addEventListener('click', ()=>{ const it = flashSequence[flashIndex]; toggleKnown(it.id); updateFlash(); });
window.addEventListener('keydown', (e)=>{
  if($('.tab.active').dataset.tab!=='flash') return;
  if(e.key===' ') { e.preventDefault(); flashReveal=!flashReveal; updateFlash(); }
  if(e.key==='ArrowRight'){ $('#flashNext').click(); }
  if(e.key==='ArrowLeft'){ $('#flashPrev').click(); }
});

// ‚Äî‚Äî‚Äî‚Äî‚Äî Quiz ‚Äî‚Äî‚Äî‚Äî‚Äî
function startQuiz(){
  state.quiz.score = 0; state.quiz.total = 0; $('#quizScore').textContent = '0 / 0';
  const qs = shuffle([...DATA]).slice(0,10);
  const area = $('#quizArea'); area.innerHTML='';
  qs.forEach((q,i)=>{
    const block = document.createElement('div'); block.className='quiz-q';
    block.innerHTML = `<div class=\"de\"><span class=\"tiny\">–í–æ–ø—Ä–æ—Å ${i+1}:</span> ${q.de}</div>`;
    const answers = document.createElement('div'); answers.className='answers';
    const wrongs = shuffle(DATA.filter(x=>x.id!==q.id)).slice(0,3);
    const opts = shuffle([q, ...wrongs]);
    opts.forEach(opt=>{
      const btn = document.createElement('button'); btn.className='answer'; btn.textContent = opt.ru;
      btn.addEventListener('click', ()=>{
        if(btn.dataset.locked) return; btn.dataset.locked = '1';
        state.quiz.total++;
        if(opt.id===q.id){ btn.classList.add('correct'); state.quiz.score++; speak('–ü—Ä–∞–≤–∏–ª—å–Ω–æ','ru-RU',$('#voiceRU').value); }
        else { btn.classList.add('wrong'); speak('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ','ru-RU',$('#voiceRU').value); }
        $('#quizScore').textContent = `${state.quiz.score} / ${state.quiz.total}`;
        [...answers.children].forEach(b=>{ if(b.textContent===q.ru) b.classList.add('correct'); b.disabled=true; });
      });
      answers.appendChild(btn);
    });
    block.appendChild(answers);
    area.appendChild(block);
  });
}
$('#quizStart').addEventListener('click', startQuiz);

// ‚Äî‚Äî‚Äî‚Äî‚Äî Verbs & M√∂chten cloze ‚Äî‚Äî‚Äî‚Äî‚Äî
function renderVerbs(){
  const host = $('#verbs'); host.innerHTML='';
  for(const [verb, forms] of Object.entries(VERBS)){
    const card = document.createElement('div'); card.className='vcard';
    card.innerHTML = `<h3>${verb}</h3>
      <table><tbody>
        ${[
          ['ich', forms[0]],
          ['du', forms[1]],
          ['er/sie/es', forms[2]],
          ['wir', forms[3]],
          ['ihr', forms[4]],
          ['sie/Sie', forms[5]],
        ].map(([p,f])=>`<tr><td style='width:90px'>${p}</td><td>${f}</td><td style='width:54px; text-align:right'><button class='speak' data-t='${f}'>üîà</button></td></tr>`).join('')}
      </tbody></table>`;
    card.querySelectorAll('button.speak').forEach(b=> b.addEventListener('click', ()=> speak(b.dataset.t,'de-DE',$('#voiceDE').value)) );
    host.appendChild(card);
  }
}
function norm(s){ return (s||'').toLowerCase().trim().replaceAll('√∂','oe').replaceAll('√§','ae').replaceAll('√º','ue').replaceAll('√ü','ss'); }
$('#moeCheck').addEventListener('click', ()=>{
  $$('#moechtenCloze input').forEach(inp=>{
    inp.classList.remove('ok','bad');
    const want = (inp.dataset.a||'').split('|').map(norm);
    const got = norm(inp.value);
    if(want.includes(got)){ inp.classList.add('ok'); }
    else { inp.classList.add('bad'); }
  });
});
$('#moeShow').addEventListener('click', ()=>{
  $$('#moechtenCloze input').forEach(inp=>{ const ans = (inp.dataset.a||''); inp.value = ans.split('|')[0].replace('oe','√∂'); inp.classList.remove('bad'); inp.classList.add('ok'); });
});

// ‚Äî‚Äî‚Äî‚Äî‚Äî Numbers 0‚Äì100 ‚Äî‚Äî‚Äî‚Äî‚Äî
const BASE = {0:'null',1:'eins',2:'zwei',3:'drei',4:'vier',5:'f√ºnf',6:'sechs',7:'sieben',8:'acht',9:'neun',10:'zehn',11:'elf',12:'zw√∂lf',13:'dreizehn',14:'vierzehn',15:'f√ºnfzehn',16:'sechzehn',17:'siebzehn',18:'achtzehn',19:'neunzehn',20:'zwanzig',30:'drei√üig',40:'vierzig',50:'f√ºnfzig',60:'sechzig',70:'siebzig',80:'achtzig',90:'neunzig',100:'hundert'};
function germanNumber(n){
  if(n in BASE) return BASE[n];
  if(n<100){ const tens = Math.floor(n/10)*10, u = n%10; const unit = (u===1? 'ein':'') || BASE[u]; return `${unit || ''}${u===1?'':'und'}${BASE[tens]}`.replace('einsund','einund'); }
  return '';
}
let nums = Array.from({length:101}, (_,i)=> i);
let numsShuffled = false;
function renderNumbers(){
  const q = ($('#numSearch').value||'').toLowerCase().trim();
  const arr = numsShuffled ? shuffle(nums) : nums;
  const host = $('#numbers'); host.innerHTML='';
  arr.forEach(n=>{
    const word = germanNumber(n);
    if(q && !(String(n).includes(q) || word.toLowerCase().includes(q))) return;
    const card = document.createElement('div'); card.className='ncard';
    card.innerHTML = `<div class='nnum'>${n}</div><div class='nword'>${word}</div><div><button class='speakN' data-t='${word}'>üîà</button></div>`;
    card.querySelector('button.speakN').addEventListener('click', ()=> speak(word,'de-DE',$('#voiceDE').value));
    host.appendChild(card);
  });
}
$('#numSearch').addEventListener('input', renderNumbers);
$('#numShuffle').addEventListener('click', ()=>{ numsShuffled = !numsShuffled; renderNumbers(); });

// ‚Äî‚Äî‚Äî‚Äî‚Äî Voices ‚Äî‚Äî‚Äî‚Äî‚Äî
function populateVoices(){
  const voices = speechSynthesis.getVoices();
  const deVoices = voices.filter(v=> v.lang.toLowerCase().startsWith('de'));
  const ruVoices = voices.filter(v=> v.lang.toLowerCase().startsWith('ru'));
  function fill(sel, list){ const el = $(sel); const cur = el.value; el.innerHTML = list.map(v=>`<option value="${v.name}">${v.name} (${v.lang})</option>`).join(''); if(cur) el.value = cur; }
  fill('#voiceDE', deVoices.length?deVoices:voices);
  fill('#voiceRU', ruVoices.length?ruVoices:voices);
}
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = populateVoices; setTimeout(populateVoices, 0); }

// ‚Äî‚Äî‚Äî‚Äî‚Äî Tabs & Controls ‚Äî‚Äî‚Äî‚Äî‚Äî
function activateTab(name){
  $$('.tab').forEach(x=>{ const on = x.dataset.tab===name; x.classList.toggle('active', on); x.setAttribute('aria-selected', on?'true':'false'); });
  $$('.tab-panel').forEach(p=> p.classList.add('hidden'));
  const pane = $('#tab-'+name); if(pane) pane.classList.remove('hidden');
  if(name==='flash') renderFlash();
  if(name==='verbs') renderVerbs();
  if(name==='numbers') renderNumbers();
}
$$('.tab').forEach(t=> t.addEventListener('click', ()=> activateTab(t.dataset.tab)));

$('#search').addEventListener('input', renderList);
$('#difficulty').addEventListener('change', ()=>{ renderList(); renderFlash(); });
$('#shuffle').addEventListener('click', ()=>{ state.shuffled = !state.shuffled; renderList(); renderFlash(); $('#shuffle').textContent = state.shuffled?'üîÄ –ü–µ—Ä–µ–º–µ—à–∞–Ω–æ':'üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å'; });
$('#rate').addEventListener('input', ()=>{ state.rate = parseFloat($('#rate').value)||1.0; });
$('#resetProgress').addEventListener('click', ()=>{ if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –æ—Ç–º–µ—Ç–∫–∏ "–ó–Ω–∞—é"?')){ state.known.clear(); saveKnown(); renderList(); }});
$('#exportData').addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify({known:[...state.known], imgs: state.imgs}, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='lektion3_progress.json'; a.click(); URL.revokeObjectURL(a.href); });
$('#importBtn').addEventListener('click', ()=> $('#importData').click());
$('#importData').addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(!f) return; const text = await f.text(); try{ const j = JSON.parse(text); if(j.known) state.known = new Set(j.known); if(j.imgs) state.imgs = j.imgs; saveKnown(); saveImgs(); renderList(); renderFlash(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!'); } catch(err){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª.'); } });

// Initial
renderList();
renderFlash();
renderVerbs();
renderNumbers();
</script>
</body>
</html>
